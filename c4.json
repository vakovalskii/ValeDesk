{"contexts":{"LocalDesk":{"description":"Десктопный ИИ-ассистент с открытой архитектурой, поддерживающий локальные (Ollama, vLLM) и удаленные (OpenAI) языковые модели. Основной упор сделан на приватность, расширяемость через инструменты (tools) и навыки (skills), а также наличие безопасных песочниц для исполнения кода.","c4_level":"Context","security_posture":{"description":"Многоуровневая система безопасности для выполнения кода и инструментов.","c4_level":"Context","mechanisms":{"Rust_JS_Sandbox":"Использование `boa_engine` в Rust для выполнения JavaScript. Обеспечивает высокую изоляцию, так как движок не имеет доступа к системным вызовам по умолчанию.","Node_JS_Sandbox":"Использование модуля `vm` в Node.js Sidecar. Применяется белый список разрешенных API (Math, JSON, Date) и блокировка опасных объектов (process, require, global).","Python_Execution":"Запуск через системный subprocess с ограничением рабочей директории (CWD) и очищенным/дополненным окружением (PATH).","Path_Safety":"Принудительная проверка всех путей через функцию `isPathSafe` перед выполнением файловых операций (fs.readFileSync, fs.writeFileSync), предотвращающая выход за пределы CWD (Path Traversal)."}},"observability":{"logging":{"strategy":"Стриминговое логирование в stderr. Sidecar использует JSON-формат для передачи логов через stdout, которые затем парсятся и перенаправляются в stderr основного процесса Tauri.","levels":"Поддерживается уровень 'debug' для SDK (через переменные окружения DEBUG, ANTHROPIC_LOG_LEVEL).","formats":"Sidecar: JSON { type: 'log', level: string, message: string }. Основной процесс: Plain text (eprintln!). External Proxy: Plain text с JSON-дампами тел запросов.","c4_level":"Context"},"sidecar_bridge":{"mechanism":"Перехват потоков Stdout/Stderr. Tauri-процесс читает потоки Sidecar в реальном времени, обеспечивая централизованный сбор логов в консоли хоста.","c4_level":"Container"},"metrics_and_tracing":{"metrics":"Сбор метрик использования токенов (input_tokens, output_tokens) для каждой сессии с сохранением в SQLite.","tracing":"Специализированные системы трейсинга отсутствуют; отладка выполняется через расширенное логирование сетевой активности (NODE_DEBUG=http,https).","c4_level":"Component"}}}},"containers":{"TauriApp":{"description":"Основной целевой контейнер приложения. На Rust реализованы: работа с SQLite, системные API, управление окнами и запуск Node.js Sidecar.","c4_level":"Container","api_surface":{"protocol":"Asynchronous JSON-RPC events over IPC (Electron/Tauri)","channels":{"client-event":"UI -> Host: Requests for session management, settings, and task execution.","server-event":"Host -> UI: Responses, streaming messages, status updates, and errors."},"message_formats":{"inbound":"ClientEvent union (e.g., session.start, task.create)","outbound":"ServerEvent union (e.g., stream.message, session.status)"},"c4_level":"Container"}},"NodeSidecar":{"description":"Вспомогательный процесс Node.js, управляемый Tauri. Выполняет логику агента и инструментов, используя код, ранее работавший в основном процессе Electron.","c4_level":"Container","api_surface":{"protocol":"JSON-RPC over StdIO (stdin/stdout)","inbound_format":"{ \"type\": \"client-event\", \"event\": ClientEvent }","outbound_format":"{ \"type\": \"server-event\", \"event\": ServerEvent } | { \"type\": \"log\", \"level\": string, \"message\": string }","c4_level":"Container"}},"ElectronApp":{"description":"Legacy-контейнер приложения на базе Electron. Содержит полную реализацию управления окнами и IPC, которая постепенно переносится в Rust (Tauri).","c4_level":"Container"}},"domain_glossary":{"Session":"История переписки и состояние текущей задачи, сохраняемые в базе данных SQLite.","Tool":"Функция, которую ИИ может вызывать для взаимодействия с внешним миром (файлы, сеть, команды ОС).","Skill":"Набор специализированных инструкций или инструментов, расширяющих возможности агента.","Sidecar":"Вспомогательный процесс Node.js, управляемый основным приложением Tauri, отвечающий за логику LLM и выполнение инструментов.","Sandbox":"Изолированная среда для безопасного выполнения кода (QuickJS для JavaScript, системный подпроцесс для Python).","Memory":"Персистентное хранилище предпочтений пользователя, хранящееся в файле memory.md.","CWD":"Current Working Directory — рабочая директория сессии, ограничивающая область видимости файловых операций.","ToolExecutor":"Центральный компонент для выполнения инструментов. Проверяет безопасность путей, управляет контекстом выполнения и делегирует вызовы конкретным реализациям.","PathSafety":"Механизм безопасности, ограничивающий операции с файлами пределами рабочей директории (CWD) для предотвращения атак типа Path Traversal.","QuickJS_Sandbox":"Изолированная среда выполнения JavaScript кода на базе WebAssembly, используемая инструментом execute_js.","ScheduledTask":"Запись в БД, описывающая задачу для ИИ, которая должна быть выполнена в определенное время или с определенной периодичностью.","SkillMarketplace":"Внешний репозиторий (GitHub), содержащий наборы инструкций и инструментов (навыки), доступные для установки в приложение.","Frontmatter":"Блок метаданных в формате YAML в начале файла SKILL.md, описывающий свойства и ограничения навыка.","WebCache":"Механизм временного хранения результатов сетевых запросов для предотвращения избыточного трафика и ускорения ответов агента."},"deployment_topology":{"Application":"Кроссплатформенное десктопное приложение (Windows, macOS, Linux) на базе Tauri.","Backend":"Rust (Tauri) для управления окнами, системных API и работы с БД.","Agent Logic":"Node.js Sidecar для работы с LLM SDK и выполнения инструментов.","Frontend":"React WebView для пользовательского интерфейса.","Storage":"Локальная БД SQLite (sessions.db) и файловая система (~/.localdesk).","External":"LLM провайдеры (локальные через HTTP или облачные API).","migration_status":"Проект находится в активной фазе миграции с Electron на Tauri. Tauri является целевой платформой для продакшена.","sidecar_build":{"description":"Процесс создания автономного бинарного файла Sidecar.","c4_level":"Container","steps":["Копирование промптов: `npm run copy:sidecar-prompts`","Сборка бандла: `esbuild src/sidecar/main.ts` (target: node18, format: cjs, external: [better-sqlite3, sharp, electron, playwright])","Упаковка: `pkg dist-sidecar/bundled.js` с таргетом под конкретную ОС (node18-win/macos/linux-x64/arm64)","Выходной файл: `src-tauri/bin/local-desk-sidecar-{target}`"]},"environment_setup":{"description":"Требования и скрипты подготовки окружения для разработки и сборки.","c4_level":"Context","requirements":{"Rust":"Минимальная версия 1.74.0","Node.js":"Наличие npm, установка через `npm ci`","Tauri_CLI":"Установка через `cargo install tauri-cli --locked`","Native_Modules":"Принудительная пересборка `better-sqlite3` через `npm rebuild`"},"scripts":{"ensure_deps":"Интерактивная проверка и установка cargo, node, npm (scripts/ensure_deps.ps1)","build_info":"Генерация src/electron/build-info.json с версией и хешем коммита"}},"build_system":{"description":"Сборка Tauri приложения с использованием Rust build.rs для подготовки ресурсов.","icon_handling":"Автоматическая генерация или проверка RGBA PNG иконки перед компиляцией.","c4_level":"Container"}},"data_schema":{"SQLite":{"description":"Основное хранилище приложения (sessions.db), расположенное в директории данных пользователя (App Data). Использует rusqlite.","tables":{"sessions":{"description":"Сессии чата и их метаданные.","columns":{"id":"TEXT PRIMARY KEY","title":"TEXT NOT NULL","claude_session_id":"TEXT (ID сессии во внешнем API)","status":"TEXT NOT NULL DEFAULT 'idle' (состояние выполнения)","cwd":"TEXT (рабочая директория сессии)","allowed_tools":"TEXT (список разрешенных инструментов)","last_prompt":"TEXT","model":"TEXT","thread_id":"TEXT","temperature":"REAL","is_pinned":"INTEGER DEFAULT 0","input_tokens":"INTEGER DEFAULT 0","output_tokens":"INTEGER DEFAULT 0","todos":"TEXT (JSON-список задач)","file_changes":"TEXT (JSON-список изменений файлов)","created_at":"INTEGER NOT NULL (timestamp ms)","updated_at":"INTEGER NOT NULL (timestamp ms)"}},"messages":{"description":"История сообщений, привязанная к сессиям.","columns":{"id":"TEXT PRIMARY KEY","session_id":"TEXT NOT NULL (FK -> sessions.id)","data":"TEXT NOT NULL (JSON-содержимое сообщения)","created_at":"INTEGER NOT NULL"},"indexes":["messages_session_id"]},"scheduled_tasks":{"description":"Запланированные задачи автоматизации.","columns":{"id":"TEXT PRIMARY KEY","title":"TEXT NOT NULL","prompt":"TEXT","schedule":"TEXT NOT NULL (cron-like или интервал)","next_run":"INTEGER NOT NULL","is_recurring":"INTEGER DEFAULT 0","notify_before":"INTEGER","enabled":"INTEGER DEFAULT 1","created_at":"INTEGER NOT NULL","updated_at":"INTEGER NOT NULL"},"indexes":["scheduled_tasks_next_run","scheduled_tasks_enabled"]},"settings":{"description":"Хранилище настроек в формате Key-Value.","columns":{"key":"TEXT PRIMARY KEY","value":"TEXT NOT NULL (обычно JSON)","updated_at":"INTEGER NOT NULL"}},"providers":{"description":"Конфигурация провайдеров LLM (OpenAI, Anthropic и др.).","columns":{"id":"TEXT PRIMARY KEY","name":"TEXT NOT NULL","type":"TEXT NOT NULL","base_url":"TEXT","api_key":"TEXT (хранится в открытом виде в БД)","enabled":"INTEGER DEFAULT 1","config":"TEXT (JSON-конфиг)","created_at":"INTEGER NOT NULL","updated_at":"INTEGER NOT NULL"}},"models":{"description":"Доступные модели для каждого провайдера.","columns":{"id":"TEXT PRIMARY KEY","provider_id":"TEXT NOT NULL (FK -> providers.id ON DELETE CASCADE)","name":"TEXT NOT NULL","enabled":"INTEGER DEFAULT 1","config":"TEXT (JSON-конфиг)"},"indexes":["models_provider_id"]},"skills":{"description":"Метаданные установленных навыков (плагинов).","columns":{"id":"TEXT PRIMARY KEY","name":"TEXT NOT NULL","description":"TEXT","category":"TEXT","author":"TEXT","version":"TEXT","repo_path":"TEXT","enabled":"INTEGER DEFAULT 0","last_updated":"INTEGER"}}},"migration_process":{"initialization":"Использование 'CREATE TABLE IF NOT EXISTS' при запуске приложения в методе Database::initialize.","incremental_updates":"Ручные миграции через 'ALTER TABLE' внутри Database::initialize (например, добавление колонки temperature).","legacy_import":"Функция migrate_json_to_db в main.rs переносит данные из api-settings.json и llm-providers-settings.json в SQLite при первом запуске."}}},"components":{"AgentRunner":{"description":"Ядро выполнения агента на базе OpenAI SDK (заменило Claude SDK). Реализует ReAct-цикл с детекцией бесконечных циклов, стримингом ответов и интеграцией с Git для трекинга изменений.","c4_level":"Component","loop_policy":{"max_iterations":50,"loop_detection_threshold":5,"retry_strategy":"Exponential backoff для сетевых ошибок (3 попытки)","c4_level":"Code"}},"SessionStorage":{"description":"Персистентное хранилище на базе SQLite (better-sqlite3). Отвечает за хранение метаданных сессий, истории сообщений, списка задач (todos) и изменений файлов.","c4_level":"Component"},"LLMProviderService":{"description":"Сервис интеграции с внешними API (OpenAI, OpenRouter, Z.AI) и локальным Claude Code. Управляет аутентификацией и получением списков моделей.","c4_level":"Component"},"ToolSystem":{"description":"Система управления инструментами агента. Обеспечивает регистрацию, фильтрацию на основе настроек пользователя и безопасное выполнение через ToolExecutor. Включает механизмы проверки безопасности путей (Path Safety) и изоляции выполнения кода (QuickJS Sandbox).","c4_level":"Component"},"SchedulerService":{"description":"Сервис управления фоновыми задачами. Обеспечивает циклическую проверку очереди задач в SQLite, расчет времени следующего запуска для рекуррентных задач и отправку уведомлений.","c4_level":"Component"},"SkillSystem":{"description":"Система управления навыками агента. Включает загрузчик из внешних репозиториев (GitHub) , парсер метаданных из SKILL.md и хранилище настроек. Поддерживает глобальный и локальный (внутри CWD) кэш навыков.","c4_level":"Component"},"WebCache":{"description":"Система кэширования результатов веб-поиска и содержимого страниц с поддержкой TTL. Позволяет разделять результаты между потоками в рамках одной сессии.","c4_level":"Component"},"MemorySessionStore":{"description":"In-memory runtime store for sessions, messages, and todos. Avoids native SQLite dependencies in the Sidecar binary.","sync_mechanism":"Uses a syncCallback to emit 'session.sync' events to the Rust host for persistence in the main SQLite DB.","c4_level":"Component"},"AppStore":{"description":"Централизованное хранилище состояния на базе Zustand. Управляет сессиями, задачами, настройками и историей сообщений.","key_features":["Реактивное обновление UI на основе входящих ServerEvents","Единый диспетчер handleServerEvent для синхронизации состояния","Поддержка многопоточных задач и управления токенами"],"c4_level":"Component"},"IPCBridge":{"description":"Слой абстракции для взаимодействия с хост-процессом. Использует хук useIPC и платформенные адаптеры для изоляции UI от специфики Electron/Tauri.","c4_level":"Component"},"UI_Modules":{"description":"Набор React-компонентов для интерфейса: Sidebar (навигация), TaskDialog (создание задач), PromptInput (ввод).","c4_level":"Component"},"UI_Layer":{"description":"Слой представления на базе React и Tailwind CSS. Использует Radix UI для доступных компонентов интерфейса.","c4_level":"Component","state_management":"Zustand (AppStore) для синхронизации состояния сессий, задач и настроек.","rendering":"Markdown с поддержкой Mermaid (диаграммы) и Highlight.js (код).","key_modules":{"TaskManagement":"TaskDialog и MultiThreadPanel для создания и мониторинга параллельных сессий LLM.","MessageLog":"EventCard и DecisionPanel для отображения диалога и обработки запросов на выполнение инструментов.","FileOperations":"FileBrowser и TodoPanel для навигации по CWD и управления изменениями (Confirm/Rollback)."}},"IPC_Architecture":{"description":"Абстрактный слой взаимодействия UI с хост-процессом через PlatformAdapter.","c4_level":"Component","mechanisms":{"Events":"Асинхронный обмен через sendClientEvent (UI -> Host) и onServerEvent (Host -> UI).","Invocations":"Промисифицированные вызовы invoke для получения данных (build-info, list-directory, read-memory).","Adapters":"Поддержка Tauri, Electron и Web (mock) платформ."}},"GitIntegration":{"description":"Утилиты для работы с Git, используемые для отслеживания изменений в рабочей директории и отката правок.","c4_level":"Component","features":["Расчет диффов (additions/deletions) для измененных и новых файлов","Проверка статуса репозитория","Возврат файлов к состоянию HEAD"]}},"external_integrations":{"LLMProviders":{"description":"Поддерживаемые провайдеры: OpenAI (Bearer Auth), OpenRouter (Bearer Auth), Z.AI (Bearer Auth + API Prefix), Claude Code (SDK + Local Executable).","c4_level":"Context"},"Tavily":{"description":"API для поиска в вебе и извлечения контента страниц, используемое в WebSearchTool и ExtractPageContentTool.","c4_level":"Context"},"ZAI":{"description":"API для поиска и парсинга веб-страниц (Reader API), используемое в ZaiWebSearch и ZaiReaderTool.","c4_level":"Context"},"Playwright":{"description":"Библиотека автоматизации браузера Chromium для выполнения интерактивных действий на веб-страницах.","c4_level":"Context"}},"testing_strategy":{"description":"Стратегия обеспечения качества включает E2E тестирование и механизмы мокирования компонентов инфраструктуры.","c4_level":"Context","frameworks":{"e2e":"Playwright (обнаружен в bun.lock)","unit_ts":"Не обнаружены (отсутствуют Vitest/Jest)","unit_rust":"Не автоматизированы в Makefile (предположительно стандартный cargo test)"},"layers":{"e2e":"Используется для тестирования пользовательских сценариев через Playwright.","mocking":"Мокирование sidecar-процесса через скрипты setup_sidecar_mock для обеспечения работы Tauri CLI без реального бинарного файла."},"telemetry":{"resource_monitoring":"Реализовано в src/agent/test.ts. Собирает метрики CPU, RAM и использования диска. Файл ошибочно назван 'test.ts', но выполняет функции телеметрии."},"automation":{"status":"Низкий уровень автоматизации; в Makefile отсутствуют команды для запуска тестовых сюит."}},"configuration":{"description":"Настройки хранятся в JSON файлах в userData. Ключевые параметры: permissionMode (режим подтверждения действий), конфигурация провайдеров, лимиты токенов и доступные инструменты.","c4_level":"Component","build_metadata":{"description":"Метаданные текущей сборки, используемые для отображения версии и отладки.","c4_level":"Component","fields":["version (из package.json)","commit (полный хеш git)","commitShort (короткий хеш git)","buildTime (ISO timestamp)"]},"linting_and_style":{"description":"Правила проверки кода и настройки пакетного менеджера.","c4_level":"Component","eslint":"Использование typescript-eslint, react-hooks и react-refresh. Игнорирование директории dist.","npm":"Настроены таймауты (600с) и ретраи (3) для стабильной загрузки зависимостей в .npmrc."}},"workflows_jobs":{"BackgroundTasks":"Фоновое выполнение задач: SchedulerService каждые 30 секунд проверяет таблицу scheduled_tasks. Поддерживаются интервалы (every Xm/h/d) и ежедневный запуск (daily HH:MM). При наступлении времени выполнения вызывается callback с промптом задачи.","SkillLoading":"Управление навыками: SkillsLoader получает список из GitHub Marketplace, скачивает файлы и кэширует их. Метаданные (имя, описание, разрешенные инструменты) извлекаются из frontmatter файла SKILL.md. Навыки активируются пользователем и внедряются в системный промпт."},"i18n_l10n":{"status":"Отсутствует","description":"На текущий момент в приложении нет системы интернационализации. Все интерфейсные строки жестко закодированы в коде компонентов на английском языке. Библиотеки i18next или react-intl не обнаружены.","c4_level":"Component"}}